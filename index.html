<!DOCTYPE html>
<html lang="es">
<head>
    <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FireGuard Pro | IntegratCore</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        :root { --bg: #020617; --text: #f8fafc; --accent: #2563eb; }
        body { background: var(--bg); color: var(--text); font-family: 'Plus Jakarta Sans', sans-serif; overflow-x: hidden; }
        .glass-card { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; }
        .input-xl { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 14px; padding: 16px; color: white; width: 100%; font-size: 16px; }
        .sidebar { position: fixed; top: 0; left: -320px; width: 300px; height: 100%; background: #0f172a; z-index: 5000; transition: 0.4s; border-right: 1px solid rgba(255,255,255,0.1); }
        .sidebar.active { left: 0; }
        .btn-xl { background: linear-gradient(135deg, #2563eb, #1e40af); padding: 18px; border-radius: 16px; font-weight: 800; width: 100%; text-transform: uppercase; }
        .hidden-force { display: none !important; }
    </style>
</head>
<body>

    <div id="loginGate" class="fixed inset-0 z-[6000] bg-slate-950 flex items-center justify-center p-6">
        <div class="w-full max-w-sm text-center">
            <h2 class="text-4xl font-black italic mb-10 text-white">FIRE<span class="text-blue-500">GUARD</span></h2>
            <div class="glass-card p-10">
                <input type="password" id="passInput" class="input-xl text-center text-2xl mb-6 tracking-widest" placeholder="â€¢â€¢â€¢â€¢">
                <button onclick="access()" class="btn-xl text-white">Iniciar SesiÃ³n</button>
            </div>
        </div>
    </div>

    <nav id="sidebar" class="sidebar p-8">
        <div class="flex justify-between items-center mb-10">
            <span class="text-blue-500 font-black italic">INTEGRATCORE v3</span>
            <button onclick="toggleMenu()" class="text-2xl"><i class="fas fa-times"></i></button>
        </div>
        <div class="space-y-4">
            <button onclick="location.reload()" class="w-full flex items-center gap-4 p-4 rounded-xl hover:bg-white/5"><i class="fas fa-sync"></i> Actualizar Sistema</button>
            <button onclick="openCalc()" class="w-full flex items-center gap-4 p-4 rounded-xl hover:bg-white/5"><i class="fas fa-calculator"></i> Calculadora Financiera</button>
            <button onclick="Swal.fire('Historial','MÃ³dulo de pagos en desarrollo','info')" class="w-full flex items-center gap-4 p-4 rounded-xl hover:bg-white/5"><i class="fas fa-history"></i> Historial de Bloqueos</button>
            <button onclick="Swal.fire('Soporte','WhatsApp de soporte: +1 829-XXX-XXXX','info')" class="w-full flex items-center gap-4 p-4 rounded-xl hover:bg-white/5 text-green-400"><i class="fab fa-whatsapp"></i> Soporte TÃ©cnico</button>
            <hr class="opacity-10">
            <button onclick="logout()" class="w-full flex items-center gap-4 p-4 rounded-xl bg-red-500/10 text-red-500"><i class="fas fa-sign-out-alt"></i> Cerrar SesiÃ³n</button>
        </div>
    </nav>

    <main id="appContent" class="hidden-force min-h-screen p-4 md:p-10 max-w-[1200px] mx-auto">
        <header class="flex justify-between items-center mb-8">
            <button onclick="toggleMenu()" class="w-14 h-14 glass-card flex items-center justify-center text-blue-500 text-2xl"><i class="fas fa-bars"></i></button>
            <div class="text-right">
                <p id="roleName" class="text-[10px] font-black text-blue-500 uppercase">--</p>
                <p id="totalCap" class="text-xl font-black italic">RD$ 0</p>
            </div>
        </header>

        <div class="space-y-6">
            <section class="glass-card p-6">
                <h3 class="text-xs font-black text-blue-500 uppercase mb-6 italic"><i class="fas fa-user-plus mr-2"></i>Nuevo Registro</h3>
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="fn" class="input-xl" placeholder="Nombre">
                        <input type="text" id="ln" class="input-xl" placeholder="Apellido">
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <select id="country" class="input-xl bg-slate-800">
                            <option value="+1">Dominicana ðŸ‡©ðŸ‡´ (+1)</option>
                            <option value="+599">Curazao ðŸ‡¨ðŸ‡¼ (+599)</option>
                            <option value="+507">PanamÃ¡ ðŸ‡µðŸ‡¦ (+507)</option>
                            <option value="+1">USA ðŸ‡ºðŸ‡¸ (+1)</option>
                            <option value="+58">Venezuela ðŸ‡»ðŸ‡ª (+58)</option>
                            <option value="+57">Colombia ðŸ‡¨ðŸ‡´ (+57)</option>
                        </select>
                        <input type="tel" id="tel" class="input-xl" placeholder="WhatsApp">
                    </div>

                    <input type="text" id="imei" class="input-xl border-blue-500/30" placeholder="IMEI / ID de Dispositivo">

                    <div class="grid grid-cols-2 gap-4">
                        <input type="number" id="amt" class="input-xl font-bold text-blue-400" placeholder="Monto">
                        <input type="number" id="ins" class="input-xl" placeholder="Cuotas">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center">
                            <label class="text-[9px] uppercase font-bold opacity-50">Foto Equipo</label>
                            <input type="file" id="fEq" class="mt-2 text-[10px]">
                        </div>
                        <div class="text-center">
                            <label class="text-[9px] uppercase font-bold opacity-50">CÃ©dula Frente</label>
                            <input type="file" id="fFr" class="mt-2 text-[10px]">
                        </div>
                    </div>

                    <button id="saveBtn" onclick="saveClient()" class="btn-xl text-white mt-4">Sincronizar Maestro</button>
                </div>
            </section>

            <section class="glass-card p-4">
                <div id="mainList" class="space-y-4">
                    </div>
            </section>
        </div>
    </main>

    <script>
        const db = firebase.initializeApp({ apiKey: "AIzaSyAmr8KHEyoaI3-xhKGy-uDUzCc8JkEzO6g", authDomain: "fireguard-4327f.firebaseapp.com", projectId: "fireguard-4327f", storageBucket: "fireguard-4327f.firebasestorage.app", messagingSenderId: "277545925255", appId: "1:277545925255:web:92175f4ac71dc9278b1622" }).firestore();
        const pusher = new Pusher('43b3675a0d7078d24ecc', { cluster: 'us2' });

        const MASTER_PASS = "ClaroLluvia77"; // LA CLAVE QUE PEDISTE
        const PARTNER_PASS = "Curazao2026*";

        function toggleMenu() { document.getElementById('sidebar').classList.toggle('active'); }
        function openCalc() { window.open('https://www.google.com/search?q=calculadora', '_blank', 'width=400,height=600'); }

        // LOGIN BLINDADO
        function access() {
            const val = document.getElementById('passInput').value;
            if(val === MASTER_PASS || val === PARTNER_PASS) {
                localStorage.setItem('session', val === MASTER_PASS ? 'ADMIN' : 'PARTNER');
                location.reload();
            } else {
                localStorage.clear();
                Swal.fire('Acceso Denegado', 'La clave no es vÃ¡lida', 'error');
            }
        }

        async function compress(file) {
            return new Promise(r => {
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image(); img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = 500; canvas.height = (img.height * 500) / img.width;
                        canvas.getContext('2d').drawImage(img, 0, 0, 500, canvas.height);
                        r(canvas.toDataURL('image/jpeg', 0.5));
                    }
                }
            });
        }

        async function saveClient() {
            const btn = document.getElementById('saveBtn');
            const f1 = document.getElementById('fEq').files[0];
            const f2 = document.getElementById('fFr').files[0];
            if(!f1 || !f2) return Swal.fire('Error', 'Sube las fotos', 'warning');

            btn.disabled = true; btn.innerText = "COMPRIMIENDO...";
            try {
                const img1 = await compress(f1); const img2 = await compress(f2);
                await db.collection("clientes").add({
                    n: document.getElementById('fn').value, a: document.getElementById('ln').value,
                    tel: document.getElementById('country').value + document.getElementById('tel').value,
                    imei: document.getElementById('imei').value, m: parseFloat(document.getElementById('amt').value),
                    ins: document.getElementById('ins').value, img1, img2, date: new Date()
                });
                Swal.fire('Ã‰xito', 'Registrado', 'success').then(() => location.reload());
            } catch(e) { btn.disabled = false; btn.innerText = "REINTENTAR"; }
        }

        function init() {
            db.collection("clientes").orderBy("date", "desc").onSnapshot(snap => {
                const list = document.getElementById('mainList');
                let total = 0; list.innerHTML = "";
                snap.forEach(doc => {
                    const d = doc.data(); total += d.m;
                    list.innerHTML += `
                        <div class="p-5 border border-white/5 rounded-2xl bg-white/5 flex justify-between items-center">
                            <div>
                                <p class="text-sm font-black uppercase">${d.n} ${d.a}</p>
                                <p class="text-[10px] text-blue-500 font-bold">${d.imei} | ${d.ins} Cuotas</p>
                                <p class="text-xs mt-1 font-bold text-blue-400">RD$ ${d.m.toLocaleString()}</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="editar('${doc.id}')" class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center"><i class="fas fa-edit text-xs"></i></button>
                                <button onclick="bloquear('${d.imei}')" class="w-12 h-12 rounded-xl bg-orange-500 text-white flex items-center justify-center shadow-lg shadow-orange-500/20"><i class="fas fa-lock"></i></button>
                            </div>
                        </div>`;
                });
                document.getElementById('totalCap').innerText = "RD$ " + total.toLocaleString();
            });
        }

        function bloquear(imei) {
            Swal.fire({ title: 'Â¿BLOQUEAR?', text: 'IMEI: ' + imei, icon: 'warning', showCancelButton: true, confirmButtonColor: '#f97316', confirmButtonText: 'SÃ, APAGAR' })
            .then(r => { if(r.isConfirmed) { pusher.subscribe('private-canal-seguridad').trigger('client-orden-bloqueo', { imei }); Swal.fire('Enviado', '', 'success'); } });
        }

        async function editar(id) {
            const { value: form } = await Swal.fire({
                title: 'Editar',
                html: `<input id="e-n" class="swal2-input" placeholder="Nombre">`,
                preConfirm: () => [document.getElementById('e-n').value]
            });
            if(form) await db.collection("clientes").doc(id).update({ n: form[0] });
        }

        // VERIFICACIÃ“N DE SESIÃ“N
        const ses = localStorage.getItem('session');
        if(ses) {
            document.getElementById('loginGate').classList.add('hidden-force');
            document.getElementById('appContent').classList.remove('hidden-force');
            document.getElementById('roleName').innerText = ses;
            init();
        }
        function logout() { localStorage.clear(); location.reload(); }
    </script>
</body>
</html>
